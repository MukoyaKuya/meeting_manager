{% extends 'base.html' %}
{% load tz %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4 text-center">My Meetings</h2>

  <!-- Filters / Search -->
  <form method="get" class="row g-2 align-items-end mb-3">
    <div class="col-md-4">
      <label class="form-label">Search</label>
      <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Title, description, room...">
    </div>
    <div class="col-md-3">
      <label class="form-label">Status</label>
      <select name="status" class="form-select">
        <option value="all" {% if status == 'all' %}selected{% endif %}>All</option>
        <option value="upcoming" {% if status == 'upcoming' %}selected{% endif %}>Upcoming</option>
        <option value="ongoing" {% if status == 'ongoing' %}selected{% endif %}>Ongoing</option>
        <option value="ended" {% if status == 'ended' %}selected{% endif %}>Ended</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">From</label>
      <input type="date" name="date_from" value="{{ date_from }}" class="form-control">
    </div>
    <div class="col-md-2">
      <label class="form-label">To</label>
      <input type="date" name="date_to" value="{{ date_to }}" class="form-control">
    </div>
    <div class="col-md-1">
      <label class="form-label">Per page</label>
      <input type="number" min="1" name="per_page" value="{{ per_page }}" class="form-control">
    </div>
    <div class="col-12 d-flex gap-2">
      <button class="btn btn-dark">Apply</button>
      <a href="{% url 'meeting_list' %}" class="btn btn-outline-secondary">Reset</a>
    </div>
  </form>

  {% if meetings %}
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th>Title</th>
            <th>Description</th>
            <th>Room</th>
            <th>Start (Local)</th>
            <th>End (Local)</th>
            <th>Status</th>
            <th style="width: 210px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for meeting in meetings %}
          <tr>
            <td>{{ meeting.title }}</td>
            <td>{{ meeting.description|default:"—"|truncatewords:12 }}</td>
            <td>{{ meeting.room.name|default:"—" }}</td>
            <td>{{ meeting.start_time|localtime|date:"M d, Y H:i" }}</td>
            <td>{{ meeting.end_time|localtime|date:"M d, Y H:i" }}</td>
            <td>
              {% if meeting.start_time <= now and meeting.end_time >= now %}
                <span class="badge bg-success">Ongoing</span>
              {% elif meeting.start_time > now %}
                <span class="badge bg-primary">Upcoming</span>
              {% else %}
                <span class="badge bg-secondary">Ended</span>
              {% endif %}
            </td>
            <td>
              <a href="{% url 'meeting_detail' meeting.id %}" class="btn btn-sm btn-outline-info">View</a>
              <a href="{% url 'edit_meeting' meeting.id %}" class="btn btn-sm btn-outline-warning">Edit</a>
              <form action="{% url 'delete_meeting' meeting.id %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('Delete this meeting?');">
                  Delete
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <nav aria-label="Meetings pagination" class="mt-3">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link"
               href="?q={{ q }}&status={{ status }}&date_from={{ date_from }}&date_to={{ date_to }}&per_page={{ per_page }}&page={{ page_obj.previous_page_number }}">
              ‹ Prev
            </a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">‹ Prev</span></li>
        {% endif %}

        <li class="page-item disabled">
          <span class="page-link">Page {{ page_obj.number }} of {{ paginator.num_pages }}</span>
        </li>

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link"
               href="?q={{ q }}&status={{ status }}&date_from={{ date_from }}&date_to={{ date_to }}&per_page={{ per_page }}&page={{ page_obj.next_page_number }}">
              Next ›
            </a>
          </li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next ›</span></li>
        {% endif %}
      </ul>
    </nav>
  {% else %}
    <div class="alert alert-info text-center shadow-sm">
      No meetings found. <a href="{% url 'create_meeting' %}" class="alert-link">Create one now</a>.
    </div>
  {% endif %}
</div>
{% endblock %}
